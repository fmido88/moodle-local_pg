{"version":3,"file":"preview.min.js","sources":["../src/preview.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is used to help preview the page and highlight syntax for css and js codes.\n *\n * @module     local_pg/preview\n * @copyright  2025 Mohammad Farouk <phun.for.physics@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport Y from 'core/yui';\nimport Modal from 'core/modal';\nimport Prefetch from 'core/prefetch';\nimport Ajax from 'core/ajax';\n\n// eslint-disable-next-line camelcase\nimport {get_string} from 'core/str';\n\nPrefetch.prefetchStrings('local_pg', ['jssyntaxerror', 'csssyntaxerror']);\n\n/**\n * @type {Object}\n */\nlet draftLangs = {};\n\n/**\n * Open a modal to preview the page.\n */\nasync function preview() {\n    // Create the URL object\n    let url = new URL(M.cfg.wwwroot + '/local/pg/preview.php');\n\n    // Add parameters to the URL\n    url.searchParams.set(\"shortname\", $('[name=\"shortname\"]').val());\n    url.searchParams.set(\"header\", $('[name=\"header\"]').val());\n    url.searchParams.set(\"content\", $('[name=\"content_editor[text]\"]').val());\n    url.searchParams.set(\"contentformat\", $('[name=\"content_editor[format]\"]').val());\n    url.searchParams.set(\"layout\", $('[name=\"layout\"]').val());\n    url.searchParams.set(\"css\", $('[name=\"css\"]').val());\n    url.searchParams.set(\"js\", $('[name=\"js\"]').val());\n\n    let lang = $('[name=lang]').val();\n    if (lang) {\n        url.searchParams.set(\"lang\", lang);\n    }\n\n    // Create the modal with the updated URL\n    let modal = await Modal.create({\n        large: true,\n        show: true,\n        removeOnClose: true,\n        body: `<iframe src=\"${url.href}\" class=\"embed-responsive-item\"></iframe>`,\n        title: 'Preview'\n    });\n\n    modal.show();\n    $('[data-region=\"body\"]').addClass('embed-responsive').addClass('embed-responsive-16by9');\n    $('[data-region=\"modal\"]').attr('style', 'max-width: 100%; max-height: 100%; padding: 0; margin: 0;');\n}\n\n/**\n * Validate and save js code.\n * @param {CodeMirror} cm\n */\nasync function jsValidation(cm) {\n    let errorPlaceholder = $('#js-text-error');\n\n    var code = cm.getValue();\n    try {\n        // Basic syntax check\n        // eslint-disable-next-line no-new-func\n        Function(code);\n        cm.save();\n        errorPlaceholder.text('');\n        errorPlaceholder.hide();\n        $('input[type=submit]').removeAttr('disabled');\n    } catch (e) {\n        errorPlaceholder.text(await get_string('jssyntaxerror', 'local_pg', e.message));\n        errorPlaceholder.show();\n        $('input[type=submit]').attr('disabled', true);\n    }\n}\n\n/**\n * Validate and save css code.\n * @param {CodeMirror} cm\n */\nasync function validateCSS(cm) {\n    let errorPlaceholder = $('#css-text-error');\n\n    let cssCode = cm.getValue().trim();\n    let errors = [];\n\n    if (typeof window.CSSLint !== 'undefined') {\n        let result = window.CSSLint.verify(cssCode);\n        errors = result.messages.map(msg => `Line ${msg.line}: ${msg.message}`);\n    } else {\n        try {\n            let style = document.createElement(\"style\");\n            style.textContent = cssCode;\n            document.head.appendChild(style);\n            if (style.sheet.cssRules.length === 0 && cssCode !== \"\") {\n                errors.push(\"Invalid CSS detected.\");\n            }\n            document.head.removeChild(style);\n        } catch (e) {\n            errors.push(\"Invalid CSS syntax.\");\n        }\n    }\n\n    if (errors.length > 0) {\n        errorPlaceholder.text(await get_string('csssyntaxerror', 'local_pg', errors.join(\"\\n\")));\n        errorPlaceholder.show();\n    } else {\n        cm.save();\n        errorPlaceholder.text('');\n        errorPlaceholder.hide();\n    }\n}\n/**\n * Save draft values of langs in memory.\n */\nfunction savedraftlang() {\n    let lang = $('[name=lang]').val();\n    let title = $('[name=header]').val();\n    let content = $('[name=\"content_editor[text]\"]').val();\n\n    draftLangs[lang] = {\n        header: title,\n        content: content\n    };\n    // eslint-disable-next-line no-console\n    console.log(draftLangs);\n}\n/**\n * Fires when the language changed.\n */\nasync function changeLang() {\n    // eslint-disable-next-line no-console\n    console.log(draftLangs);\n    let lang = $('[name=lang]').val();\n    let disable = lang != \"\";\n\n    $('[name=shortname]').attr('readonly', disable);\n\n    if (draftLangs[lang]) {\n        if (draftLangs[lang].header) {\n            $('[name=header]').val(draftLangs[lang].header);\n        }\n\n        if (draftLangs[lang].content) {\n            $('[name=\"content_editor[text]\"]').val(draftLangs[lang].content);\n            $('#id_content_editoreditable').html(draftLangs[lang].content);\n        }\n\n        return;\n    }\n\n    draftLangs[lang] = {\n        header: undefined,\n        content: undefined\n    };\n\n    let requests = Ajax.call([{\n        methodname: 'local_pg_get_lang_content',\n        args: {\n            id: $('[name=id]').val(),\n            lang: lang\n        }\n    }]);\n\n    let response = await requests[0];\n    if (response.header) {\n        $('[name=header]').val(response.header);\n\n        draftLangs[lang].header = response.header;\n    }\n\n    if (response.content) {\n        $('[name=\"content_editor[text]\"]').val(response.content);\n        draftLangs[lang].content = response.content;\n        $('#id_content_editoreditable').html(response.content);\n    }\n}\n\nexport const init = () => {\n    // Must be sure that the dom is ready so codemirror is loaded.\n    $(function() {\n        setTimeout(function() {\n            Y.use(['moodle-atto_html-codemirror', 'moodle-atto_html-beautify'], function(Y) {\n                var CodeMirror = Y.M.atto_html.CodeMirror;\n                var beautify = Y.M.atto_html.beautify;\n                // Load JavaScript mode\n                var jsTextarea = $('textarea[name=\"js\"]');\n                let jsCodeMirror;\n                if (jsTextarea[0]) {\n                    beautify.js_beautify(jsTextarea.val(), {\n                        // eslint-disable-next-line camelcase\n                        indent_size: 4\n                    });\n                    jsCodeMirror = CodeMirror.fromTextArea(jsTextarea[0], {\n                        lineNumbers: true,\n                        mode: 'javascript',\n                        tabSize: 4,\n                        lineWrapping: true,\n                        indentWithTabs: false,\n                        spellcheck: true,\n                    });\n                    jsCodeMirror.setSize('100%', '300px');\n                    jsCodeMirror.on('change', jsValidation);\n                }\n\n                // Load CSS mode\n                var cssTextarea = $('textarea[name=\"css\"]');\n                let cssCodeMirror;\n                if (cssTextarea[0]) {\n                    beautify.css_beautify(cssTextarea.val(), {\n                        // eslint-disable-next-line camelcase\n                        indent_size: 2\n                    });\n                    cssCodeMirror = CodeMirror.fromTextArea(cssTextarea[0], {\n                        lineNumbers: true,\n                        mode: 'css',\n                        tabSize: 2,\n                        lineWrapping: true,\n                        indentWithTabs: false,\n                        spellcheck: true,\n                    });\n                    cssCodeMirror.setSize('100%', '300px');\n                    cssCodeMirror.on('change', validateCSS);\n                }\n\n                // I need to freeze the Codemirror textarea so that the user can't change the code if selected lang not ''.\n                let langInput = $('[name=lang]');\n                langInput.on('change', function() {\n                    let readOnly = $(this).val() !== ''; // Read-only if lang is not empty\n                    if (jsCodeMirror) {\n                        jsCodeMirror.setOption(\"readOnly\", readOnly);\n                    }\n                    if (cssCodeMirror) {\n                        cssCodeMirror.setOption(\"readOnly\", readOnly);\n                    }\n                    changeLang();\n                });\n\n            });\n        }, 1000);\n\n        $('button[name=\"preview\"]').on(\"click\", function() {\n            preview();\n        });\n\n        $('[name=\"content_editor[text]\"], [name=\"header\"]').on('input, change', savedraftlang);\n\n        savedraftlang();\n    });\n};\n"],"names":["prefetchStrings","draftLangs","jsValidation","cm","errorPlaceholder","code","getValue","Function","save","text","hide","removeAttr","e","message","show","attr","validateCSS","cssCode","trim","errors","window","CSSLint","verify","messages","map","msg","line","style","document","createElement","textContent","head","appendChild","sheet","cssRules","length","push","removeChild","join","savedraftlang","lang","val","title","content","header","console","log","setTimeout","use","Y","CodeMirror","M","atto_html","beautify","jsTextarea","jsCodeMirror","js_beautify","indent_size","fromTextArea","lineNumbers","mode","tabSize","lineWrapping","indentWithTabs","spellcheck","setSize","on","cssTextarea","cssCodeMirror","css_beautify","readOnly","this","setOption","disable","html","undefined","requests","Ajax","call","methodname","args","id","response","changeLang","url","URL","cfg","wwwroot","searchParams","set","Modal","create","large","removeOnClose","body","href","addClass","preview"],"mappings":";;;;;;;oSAgCSA,gBAAgB,aAAc,CAAC,gBAAiB,uBAKrDC,WAAa,kBAyCFC,aAAaC,QACpBC,kBAAmB,mBAAE,sBAErBC,KAAOF,GAAGG,eAIVC,SAASF,MACTF,GAAGK,OACHJ,iBAAiBK,KAAK,IACtBL,iBAAiBM,2BACf,sBAAsBC,WAAW,YACrC,MAAOC,GACLR,iBAAiBK,WAAW,mBAAW,gBAAiB,aAAcG,EAAEC,UACxET,iBAAiBU,2BACf,sBAAsBC,KAAK,YAAY,mBAQlCC,YAAYb,QACnBC,kBAAmB,mBAAE,mBAErBa,QAAUd,GAAGG,WAAWY,OACxBC,OAAS,WAEiB,IAAnBC,OAAOC,QAAyB,CAEvCF,OADaC,OAAOC,QAAQC,OAAOL,SACnBM,SAASC,KAAIC,oBAAeA,IAAIC,kBAASD,IAAIZ,wBAGrDc,MAAQC,SAASC,cAAc,SACnCF,MAAMG,YAAcb,QACpBW,SAASG,KAAKC,YAAYL,OACU,IAAhCA,MAAMM,MAAMC,SAASC,QAA4B,KAAZlB,SACrCE,OAAOiB,KAAK,yBAEhBR,SAASG,KAAKM,YAAYV,OAC5B,MAAOf,GACLO,OAAOiB,KAAK,uBAIhBjB,OAAOgB,OAAS,GAChB/B,iBAAiBK,WAAW,mBAAW,iBAAkB,aAAcU,OAAOmB,KAAK,QACnFlC,iBAAiBU,SAEjBX,GAAGK,OACHJ,iBAAiBK,KAAK,IACtBL,iBAAiBM,iBAMhB6B,oBACDC,MAAO,mBAAE,eAAeC,MACxBC,OAAQ,mBAAE,iBAAiBD,MAC3BE,SAAU,mBAAE,iCAAiCF,MAEjDxC,WAAWuC,MAAQ,CACfI,OAAQF,MACRC,QAASA,SAGbE,QAAQC,IAAI7C,0BAqDI,0BAEd,WACE8C,YAAW,wBACLC,IAAI,CAAC,8BAA+B,8BAA8B,SAASC,OACrEC,WAAaD,EAAEE,EAAEC,UAAUF,WAC3BG,SAAWJ,EAAEE,EAAEC,UAAUC,SAEzBC,YAAa,mBAAE,2BACfC,aACAD,WAAW,KACXD,SAASG,YAAYF,WAAWb,MAAO,CAEnCgB,YAAa,IAEjBF,aAAeL,WAAWQ,aAAaJ,WAAW,GAAI,CAClDK,aAAa,EACbC,KAAM,aACNC,QAAS,EACTC,cAAc,EACdC,gBAAgB,EAChBC,YAAY,IAEhBT,aAAaU,QAAQ,OAAQ,SAC7BV,aAAaW,GAAG,SAAUhE,mBAI1BiE,aAAc,mBAAE,4BAChBC,cACAD,YAAY,KACZd,SAASgB,aAAaF,YAAY1B,MAAO,CAErCgB,YAAa,IAEjBW,cAAgBlB,WAAWQ,aAAaS,YAAY,GAAI,CACpDR,aAAa,EACbC,KAAM,MACNC,QAAS,EACTC,cAAc,EACdC,gBAAgB,EAChBC,YAAY,IAEhBI,cAAcH,QAAQ,OAAQ,SAC9BG,cAAcF,GAAG,SAAUlD,eAIf,mBAAE,eACRkD,GAAG,UAAU,eACfI,SAA6B,MAAlB,mBAAEC,MAAM9B,MACnBc,cACAA,aAAaiB,UAAU,WAAYF,UAEnCF,eACAA,cAAcI,UAAU,WAAYF,2BArGxDzB,QAAQC,IAAI7C,gBACRuC,MAAO,mBAAE,eAAeC,MACxBgC,QAAkB,IAARjC,4BAEZ,oBAAoBzB,KAAK,WAAY0D,SAEnCxE,WAAWuC,aACPvC,WAAWuC,MAAMI,4BACf,iBAAiBH,IAAIxC,WAAWuC,MAAMI,aAGxC3C,WAAWuC,MAAMG,8BACf,iCAAiCF,IAAIxC,WAAWuC,MAAMG,6BACtD,8BAA8B+B,KAAKzE,WAAWuC,MAAMG,WAM9D1C,WAAWuC,MAAQ,CACfI,YAAQ+B,EACRhC,aAASgC,OAGTC,SAAWC,cAAKC,KAAK,CAAC,CACtBC,WAAY,8BACZC,KAAM,CACFC,IAAI,mBAAE,aAAaxC,MACnBD,KAAMA,SAIV0C,eAAiBN,SAAS,GAC1BM,SAAStC,6BACP,iBAAiBH,IAAIyC,SAAStC,QAEhC3C,WAAWuC,MAAMI,OAASsC,SAAStC,QAGnCsC,SAASvC,8BACP,iCAAiCF,IAAIyC,SAASvC,SAChD1C,WAAWuC,MAAMG,QAAUuC,SAASvC,4BAClC,8BAA8B+B,KAAKQ,SAASvC,UA6DlCwC,WAIT,yBAED,0BAA0BjB,GAAG,SAAS,iCA1NxCkB,IAAM,IAAIC,IAAIlC,EAAEmC,IAAIC,QAAU,2BAGlCH,IAAII,aAAaC,IAAI,aAAa,mBAAE,sBAAsBhD,OAC1D2C,IAAII,aAAaC,IAAI,UAAU,mBAAE,mBAAmBhD,OACpD2C,IAAII,aAAaC,IAAI,WAAW,mBAAE,iCAAiChD,OACnE2C,IAAII,aAAaC,IAAI,iBAAiB,mBAAE,mCAAmChD,OAC3E2C,IAAII,aAAaC,IAAI,UAAU,mBAAE,mBAAmBhD,OACpD2C,IAAII,aAAaC,IAAI,OAAO,mBAAE,gBAAgBhD,OAC9C2C,IAAII,aAAaC,IAAI,MAAM,mBAAE,eAAehD,WAExCD,MAAO,mBAAE,eAAeC,MACxBD,MACA4C,IAAII,aAAaC,IAAI,OAAQjD,aAIfkD,eAAMC,OAAO,CAC3BC,OAAO,EACP9E,MAAM,EACN+E,eAAe,EACfC,4BAAsBV,IAAIW,kDAC1BrD,MAAO,aAGL5B,2BACJ,wBAAwBkF,SAAS,oBAAoBA,SAAS,8CAC9D,yBAAyBjF,KAAK,QAAS,6DAgMjCkF,0BAGF,kDAAkD/B,GAAG,gBAAiB3B,eAExEA"}