{"version":3,"file":"preview.min.js","sources":["../src/preview.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is used to help preview the page and highlight syntax for css and js codes.\n *\n * @module     local_pg/preview\n * @copyright  2025 Mohammad Farouk <phun.for.physics@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport Modal from 'core/modal';\nimport Prefetch from 'core/prefetch';\nimport Ajax from 'core/ajax';\n/* eslint-disable camelcase */\nimport {beautify} from './beautifier';\nlet js_beautify = beautify.js;\nlet css_beautify = beautify.css;\n\nimport {get_string} from 'core/str';\n/* eslint-enable camelcase */\nimport {\n    EditorState,\n    EditorView,\n    basicSetup,\n    Compartment,\n    lang,\n} from './codemirror';\n\n\nPrefetch.prefetchStrings('local_pg', [\n    'jssyntaxerror',\n    'csssyntaxerror',\n]);\n\n/**\n * @type {Object}\n */\nlet draftLangs = {};\n\nlet cssEditorView;\nlet jsEditorView;\n/**\n * Open a modal to preview the page.\n */\nasync function preview() {\n    // Create the URL object\n    let url = new URL(M.cfg.wwwroot + '/local/pg/preview.php');\n\n    // Add parameters to the URL\n    url.searchParams.set(\"shortname\", $('[name=\"shortname\"]').val());\n    url.searchParams.set(\"header\", $('[name=\"header\"]').val());\n    url.searchParams.set(\"content\", $('[name=\"content_editor[text]\"]').val());\n    url.searchParams.set(\"contentformat\", $('[name=\"content_editor[format]\"]').val());\n    url.searchParams.set(\"layout\", $('[name=\"layout\"]').val());\n    url.searchParams.set(\"css\", $('[name=\"css\"]').val());\n    url.searchParams.set(\"js\", $('[name=\"js\"]').val());\n    url.searchParams.set(\"sesskey\", M.cfg.sesskey);\n    let idInput = $('input[name=\"id\"]');\n\n    if (idInput.length == 1) {\n        let id = idInput.val();\n        if (id) {\n            url.searchParams.set(\"id\", id);\n        }\n    }\n\n    let lang = $('[name=lang]').val();\n    if (lang) {\n        url.searchParams.set(\"lang\", lang);\n    }\n\n    // Create the modal with the updated URL\n    let modal = await Modal.create({\n        large: true,\n        show: true,\n        removeOnClose: true,\n        body: `<iframe src=\"${url.href}\" class=\"embed-responsive-item\"></iframe>`,\n        title: 'Preview'\n    });\n\n    modal.show();\n    $('[data-region=\"body\"]').addClass('embed-responsive').addClass('embed-responsive-16by9');\n    $('[data-region=\"modal\"]').css({\n        'max-width': '100%',\n        'max-height': '100%',\n        'padding': '0',\n        'margin': '0'\n    });\n}\n\n/**\n * Validate and save js code.\n * @param {CodeMirror} cm\n */\nasync function jsValidation(cm) {\n    let errorPlaceholder = $('#js-text-error');\n\n    var code = cm.state.doc.toString().trim();\n    try {\n        // Basic syntax check\n        // eslint-disable-next-line no-new-func\n        Function(code);\n        errorPlaceholder.text('');\n        errorPlaceholder.hide();\n        $('input[type=submit]').removeAttr('disabled');\n        return true;\n    } catch (e) {\n        errorPlaceholder.text(await get_string('jssyntaxerror', 'local_pg', e.message));\n        errorPlaceholder.show();\n        $('input[type=submit]').attr('disabled', true);\n        return false;\n    }\n}\n\n/**\n * Validate and save css code.\n * @param {CodeMirror} cm\n * @return {Boolean}\n */\nasync function validateCSS(cm) {\n    let errorPlaceholder = $('#css-text-error');\n\n    let cssCode = cm.state.doc.toString().trim();\n    let errors = [];\n\n    if (typeof window.CSSLint !== 'undefined') {\n        let result = window.CSSLint.verify(cssCode);\n        errors = result.messages.map(msg => `Line ${msg.line}: ${msg.message}`);\n    } else {\n        try {\n            let style = document.createElement(\"style\");\n            style.textContent = cssCode;\n            document.head.appendChild(style);\n            if (style.sheet.cssRules.length === 0 && cssCode !== \"\") {\n                errors.push(\"Invalid CSS detected.\");\n            }\n            document.head.removeChild(style);\n        } catch (e) {\n            errors.push(\"Invalid CSS syntax.\");\n        }\n    }\n\n    if (errors.length > 0) {\n        errorPlaceholder.text(await get_string('csssyntaxerror', 'local_pg', errors.join(\"<br>\\n\")));\n        errorPlaceholder.show();\n        return true;\n    } else {\n        errorPlaceholder.text('');\n        errorPlaceholder.hide();\n        return false;\n    }\n}\n/**\n * @param {HTMLElement} textarea the text area element.\n * @param {Function} validator function (validateCSS or ValidateJS).\n * @returns\n */\nfunction handleEditorUpdate(textarea, validator) {\n    return EditorView.updateListener.of(update => {\n        if (update.docChanged) {\n            let valid = validator(update);\n            if (!valid) {\n                return;\n            }\n\n            const newValue = update.state.doc.toString();\n\n            if (textarea.value !== newValue) {\n                textarea.value = newValue;\n            }\n        }\n    });\n}\n/**\n * Save draft values of langs in memory.\n */\nfunction saveDraftLang() {\n    let lang = $('[name=lang]').val();\n    let title = $('[name=header]').val();\n    let content = {\n        text: $('[name=\"content_editor[text]\"]').val(),\n        format: $('[name=\"content_editor[format]\"]').val(),\n        itemid: $('[name=\"content_editor[itemid]\"]').val()\n    };\n\n    draftLangs[lang] = {\n        header: title,\n        content: content\n    };\n}\n/**\n * Fires when the language changed.\n */\nasync function changeLang() {\n    let lang = $('[name=lang]').val();\n    let disable = lang != \"\";\n\n    $('[name=shortname]').attr('readonly', disable);\n\n    if (draftLangs[lang]) {\n        if (draftLangs[lang].header) {\n            $('[name=header]').val(draftLangs[lang].header);\n        }\n\n        if (draftLangs[lang].content) {\n            $('[name=\"content_editor[text]\"]').val(draftLangs[lang].content.text);\n            $('[name=\"content_editor[format]\"]').val(draftLangs[lang].content.format);\n            $('[name=\"content_editor[itemid]\"]').val(draftLangs[lang].content.itemid);\n            $('#id_content_editoreditable').html(draftLangs[lang].content.text);\n        }\n\n        return;\n    }\n\n    draftLangs[lang] = {\n        header: undefined,\n        content: {\n            text: undefined,\n            format: undefined,\n            itemid: undefined\n        }\n    };\n\n    let requests = Ajax.call([{\n        methodname: 'local_pg_get_lang_content',\n        args: {\n            id: $('[name=id]').val(),\n            lang: lang\n        }\n    }]);\n\n    let response = await requests[0];\n    if (response.header) {\n        $('[name=header]').val(response.header);\n\n        draftLangs[lang].header = response.header;\n    }\n\n    if (response.content_editor && response.content_editor.text) {\n        draftLangs[lang].content = response.content_editor;\n        $('[name=\"content_editor[text]\"]').val(response.content_editor.text);\n        $('#id_content_editoreditable').html(response.content_editor.text);\n\n        $('[name=\"content_editor[format]\"]').val(response.content_editor.format);\n        $('[name=\"content_editor[itemid]\"]').val(response.content_editor.itemid);\n    }\n}\n\nexport const init = () => {\n    // Must be sure that the dom is ready so codemirror is loaded.\n    $(function() {\n        // Load JavaScript mode\n        let jsTextarea = document.querySelector('textarea[name=\"js\"]');\n        const jsCompartment = new Compartment();\n\n        const editorStyle = EditorView.theme({\n                            '&': {\n                                height: '300px',\n                                width: '100%',\n                                border: '1px solid #8f959e',\n                                borderRadius: '0.5rem',\n                            },\n                        });\n        if (jsTextarea) {\n            const beautifiedJS = js_beautify(jsTextarea.value, {\n                indent_size: 4\n            });\n            jsTextarea.value = beautifiedJS;\n\n            // Create a container for CodeMirror (next to the textarea)\n            const jsContainer = document.createElement('div');\n            jsContainer.style.width = '100%';\n            jsTextarea.style.display = 'none';\n            jsTextarea.parentNode.insertBefore(jsContainer, jsTextarea.nextSibling);\n\n            jsEditorView = new EditorView({\n                state: EditorState.create({\n                    doc: beautifiedJS,\n                    extensions: [\n                        basicSetup,\n                        editorStyle,\n                        lang.javascript(),\n                        jsCompartment.of([]),\n                        handleEditorUpdate(jsTextarea, jsValidation)\n                    ]\n                }),\n                parent: jsContainer\n            });\n        }\n\n        // Load CSS mode\n        let cssTextarea = document.querySelector('textarea[name=\"css\"]');\n        const cssCompartment = new Compartment();\n\n        if (cssTextarea) {\n            const beautifiedCSS = css_beautify(cssTextarea.value, {\n                indent_size: 2\n            });\n            cssTextarea.value = beautifiedCSS;\n\n            const cssContainer = document.createElement('div');\n            cssContainer.style.width = '100%';\n            cssTextarea.style.display = 'none';\n            cssTextarea.parentNode.insertBefore(cssContainer, cssTextarea.nextSibling);\n\n            cssEditorView = new EditorView({\n                state: EditorState.create({\n                    doc: beautifiedCSS,\n                    extensions: [\n                        basicSetup,\n                        lang.css(),\n                        editorStyle,\n                        cssCompartment.of([]),\n                        handleEditorUpdate(cssTextarea, validateCSS)\n                    ]\n                }),\n                parent: cssContainer\n            });\n        }\n\n        // I need to freeze the Codemirror textarea so that the user can't change the code if selected lang not ''.\n        let langInput = $('[name=lang]');\n        langInput.on('change', function() {\n            let readOnly = $(this).val() !== ''; // Read-only if lang is not empty\n            if (jsEditorView) {\n                jsEditorView.dispatch({\n                    effects: jsCompartment.reconfigure(readOnly ? EditorView.editable.of(false) : [])\n                });\n            }\n            if (cssEditorView) {\n                cssEditorView.dispatch({\n                    effects: cssCompartment.reconfigure(readOnly ? EditorView.editable.of(false) : [])\n                });\n            }\n            changeLang();\n        });\n\n        $('button[name=\"preview\"]').on(\"click\", function() {\n            preview();\n        });\n\n        $('[name=\"content_editor[text]\"], [name=\"header\"]').on('input, change', saveDraftLang);\n\n        saveDraftLang();\n    });\n};\n"],"names":["js_beautify","beautify","js","css_beautify","css","prefetchStrings","cssEditorView","jsEditorView","draftLangs","jsValidation","cm","errorPlaceholder","code","state","doc","toString","trim","Function","text","hide","removeAttr","e","message","show","attr","validateCSS","cssCode","errors","window","CSSLint","verify","messages","map","msg","line","style","document","createElement","textContent","head","appendChild","sheet","cssRules","length","push","removeChild","join","handleEditorUpdate","textarea","validator","EditorView","updateListener","of","update","docChanged","newValue","value","saveDraftLang","lang","val","title","content","format","itemid","header","jsTextarea","querySelector","jsCompartment","Compartment","editorStyle","theme","height","width","border","borderRadius","beautifiedJS","indent_size","jsContainer","display","parentNode","insertBefore","nextSibling","EditorState","create","extensions","basicSetup","javascript","parent","cssTextarea","cssCompartment","beautifiedCSS","cssContainer","on","readOnly","this","dispatch","effects","reconfigure","editable","disable","html","undefined","requests","Ajax","call","methodname","args","id","response","content_editor","changeLang","url","URL","M","cfg","wwwroot","searchParams","set","sesskey","idInput","Modal","large","removeOnClose","body","href","addClass","preview"],"mappings":"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"}